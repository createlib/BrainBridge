<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† | BRAIN BRIDGE</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: slideDown 0.3s ease-in-out; }
        @keyframes slideDown { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        .accordion-arrow { transition: transform 0.3s ease; }
        details[open] .accordion-arrow { transform: rotate(180deg); }
        .tag-checkbox:checked + div { background-color: #3b82f6; color: white; border-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-800 font-sans pb-24">

    <!-- Header -->
    <header class="bg-white shadow sticky top-0 z-20">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-900">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† <span id="admin-label" class="hidden text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded ml-2">ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</span></h1>
            <div class="flex space-x-3">
                <button onclick="history.back()" class="text-gray-600 hover:text-gray-900 text-sm font-medium py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveProfile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-bold shadow-sm transition-colors">
                    ä¿å­˜ã™ã‚‹
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto mt-6 px-4">
        <!-- çœç•¥ã›ãšã«å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‚’å«ã‚ã¾ã™ -->
        <form id="profile-form" class="space-y-8" onsubmit="event.preventDefault();">
            
            <!-- 0. å…¬é–‹è¨­å®šãƒ»è·æ¥­ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">åŸºæœ¬è¨­å®š</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å…¬é–‹çŠ¶æ…‹</label>
                        <select name="profilePublic" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                            <option value="true">å…¬é–‹ã™ã‚‹</option>
                            <option value="false">éå…¬é–‹ï¼ˆä¸‹æ›¸ãï¼‰</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">â€»ã€Œéå…¬é–‹ã€ã«ã™ã‚‹ã¨æ¤œç´¢çµæœã‹ã‚‰ä¸€æ™‚çš„ã«é™¤å¤–ã•ã‚Œã¾ã™</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">è·æ¥­ãƒ»è‚©æ›¸</label>
                        <input type="text" name="jobTitle" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                </div>
            </div>

            <!-- 1. åŸºæœ¬æƒ…å ± -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘  åŸºæœ¬æƒ…å ±</h2>
                
                <div class="mb-6 flex flex-col items-center sm:flex-row sm:items-start space-y-4 sm:space-y-0 sm:space-x-6">
                    <div class="relative">
                        <div class="h-24 w-24 rounded-full border-2 border-gray-200 bg-gray-100 flex items-center justify-center overflow-hidden">
                            <img id="edit-icon-preview" src="" class="hidden w-full h-full object-cover">
                            <i id="edit-icon-placeholder" class="fa-solid fa-user text-3xl text-gray-300"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³</label>
                        <input type="file" id="icon-upload" accept="image/*" class="mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ°åï¼ˆè¡¨ç¤ºç”¨ï¼‰ <span class="text-red-500">*</span></label>
                            <input type="text" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ãµã‚ŠãŒãª</label>
                            <input type="text" name="nameKana" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ€§åˆ¥</label>
                            <select name="gender" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                                <option value="">æœªé¸æŠ</option>
                                <option value="ç”·æ€§">ç”·æ€§</option>
                                <option value="å¥³æ€§">å¥³æ€§</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                                <option value="å›ç­”ã—ãªã„">å›ç­”ã—ãªã„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç”Ÿå¹´æœˆæ—¥</label>
                            <input type="date" name="birthDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å…¬é–‹ç¯„å›²</label>
                            <select name="birthVisibility" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                                <option value="private">éå…¬é–‹</option>
                                <option value="monthDay">æœˆæ—¥ã®ã¿å…¬é–‹</option>
                                <option value="full">å…¨ã¦å…¬é–‹</option>
                            </select>
                        </div>
                    </div>
                    <!-- Bio -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è‡ªå·±ç´¹ä»‹ï¼ˆå…¬é–‹ãƒ»369æ–‡å­—ä»¥å†…ï¼‰</label>
                        <textarea name="bio" rows="3" maxlength="369" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border" placeholder="ã¯ã˜ã‚ã¾ã—ã¦ï¼ã€‡ã€‡ã‚’ã—ã¦ã„ã¾ã™ã€‚"></textarea>
                    </div>
                </div>
            </div>

            <!-- 2. é€£çµ¡ãƒ»å¤–éƒ¨ãƒªãƒ³ã‚¯ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¡ é€£çµ¡å…ˆãƒ»SNS</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆé€£çµ¡ç”¨ï¼‰</label>
                        <input type="email" name="contactEmail" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">WEBã‚µã‚¤ãƒˆ (URL)</label>
                            <input type="url" name="websiteUrl" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Instagram (ID/URL)</label>
                            <input type="text" name="snsInstagram" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">X (æ—§Twitter) (ID/URL)</label>
                            <input type="text" name="snsX" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. ã‚¨ãƒªã‚¢ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¢ ã‚¨ãƒªã‚¢</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">éƒ½é“åºœçœŒ</label>
                        <select name="prefecture" id="prefecture-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <!-- Options generated by JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å¸‚åŒºç”ºæ‘</label>
                        <input type="text" name="city" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                </div>
            </div>

            <!-- 4. è¶£å‘³ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘£ è¶£å‘³</h2>
                <div id="hobbies-container" class="space-y-2"></div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">ãã®ä»–</label>
                    <input type="text" name="hobbyOtherText" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                </div>
            </div>

            <!-- 5. ç‰¹æŠ€ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¤ ç‰¹æŠ€ãƒ»ã‚¹ã‚­ãƒ«</h2>
                <div id="skills-container" class="space-y-2"></div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">è£œè¶³èª¬æ˜</label>
                    <textarea name="skillDescription" rows="3" maxlength="300" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                </div>
            </div>

            <!-- 6. çµŒæ­´ -->
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-900">â‘¥ çµŒæ­´</h2>
                    <button type="button" onclick="addCareerField()" class="text-sm text-blue-600 hover:underline">+ è¿½åŠ ã™ã‚‹</button>
                </div>
                <div id="career-list" class="space-y-6"></div>
            </div>

            <!-- 7 & 8. æƒ³ã„ãƒ»ç›®æ¨™ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¦ æƒ³ã„ãƒ»â‘§ ã‚„ã‚ŠãŸã„ã“ã¨</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æƒ³ã„ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                        <textarea name="message" rows="5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ä»Šå¾Œã‚„ã‚ŠãŸã„ã“ã¨ãƒ»ç›®æ¨™</label>
                        <textarea name="goals" rows="5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                    </div>
                </div>
            </div>

            <!-- 9. ãƒãƒƒãƒãƒ³ã‚° -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¨ ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æä¾›ã§ãã‚‹ã“ã¨</label>
                        <p class="text-xs text-gray-500 mb-2">ã‚«ãƒ³ãƒ(,)åŒºåˆ‡ã‚Š</p>
                        <textarea name="canOffer" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ±‚ã‚ã¦ã„ã‚‹ã“ã¨</label>
                        <p class="text-xs text-gray-500 mb-2">ã‚«ãƒ³ãƒ(,)åŒºåˆ‡ã‚Š</p>
                        <textarea name="lookingFor" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                    </div>
                </div>
            </div>

        </form>
    </main>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden max-w-sm w-full bg-white shadow-lg rounded-lg p-4 border-l-4">
        <p id="notif-message" class="text-sm font-medium"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // â–¼â–¼â–¼â–¼ Firebase Config â–¼â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = 'default-app-id';

        let currentUser = null;
        let currentUserData = null;
        
        // â˜…é‡è¦: ç·¨é›†å¯¾è±¡ã®UIDã€‚URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°è‡ªåˆ†ã®UIDã€‚
        let targetUid = null;
        let isAdmin = false;

        // Data Definitions
        const hobbyCategories = {
            "ğŸƒ ã‚¹ãƒãƒ¼ãƒ„ãƒ»é‹å‹•ç³»": ["ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°", "ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°", "ç­‹ãƒˆãƒ¬", "ãƒ¨ã‚¬", "ãƒ”ãƒ©ãƒ†ã‚£ã‚¹", "ãƒ€ãƒ³ã‚¹", "ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«", "ã‚µãƒƒã‚«ãƒ¼", "ãƒ•ãƒƒãƒˆã‚µãƒ«", "é‡çƒ", "ãƒ†ãƒ‹ã‚¹", "ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³", "å“çƒ", "ã‚´ãƒ«ãƒ•", "ãƒœãƒ«ãƒ€ãƒªãƒ³ã‚°", "ç™»å±±", "ã‚µãƒ¼ãƒ•ã‚£ãƒ³", "ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰", "ã‚¹ã‚­ãƒ¼", "ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°", "æ°´æ³³", "æ ¼é—˜æŠ€", "æ­¦é“"],
            "ğŸµ éŸ³æ¥½ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡": ["ã‚«ãƒ©ã‚ªã‚±", "æ¥½å™¨æ¼”å¥ï¼ˆã‚®ã‚¿ãƒ¼ï¼‰", "æ¥½å™¨æ¼”å¥ï¼ˆãƒ”ã‚¢ãƒï¼‰", "ä½œæ›²", "æ­Œ", "ãƒ©ã‚¤ãƒ–é‘‘è³", "ãƒ•ã‚§ã‚¹", "DJ", "æ˜ ç”»é‘‘è³", "ã‚¢ãƒ‹ãƒ¡é‘‘è³", "æ¼«ç”»", "ã‚²ãƒ¼ãƒ ", "ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ "],
            "ğŸ¨ æ–‡åŒ–ãƒ»ã‚¢ãƒ¼ãƒˆ": ["çµµç”»", "ã‚¤ãƒ©ã‚¹ãƒˆ", "ãƒ‡ã‚¶ã‚¤ãƒ³", "å†™çœŸæ’®å½±", "å‹•ç”»ç·¨é›†", "æ‰‹èŠ¸", "DIY", "å°èª¬åŸ·ç­†", "ãƒ–ãƒ­ã‚°"],
            "ğŸ“š å­¦ã³": ["èª­æ›¸", "è‡ªå·±å•“ç™º", "æ­´å²", "å¿ƒç†å­¦", "æŠ•è³‡", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "è‹±èªå­¦ç¿’", "è³‡æ ¼å–å¾—"],
            "ğŸ³ é£Ÿãƒ»æš®ã‚‰ã—": ["æ–™ç†", "ãŠè“å­ä½œã‚Š", "ã‚«ãƒ•ã‚§å·¡ã‚Š", "é£Ÿã¹æ­©ã", "ãŠé…’", "ã‚³ãƒ¼ãƒ’ãƒ¼", "ã‚¤ãƒ³ãƒ†ãƒªã‚¢", "ãƒŸãƒ‹ãƒãƒªã‚ºãƒ "],
            "âœˆï¸ æ—…è¡Œ": ["å›½å†…æ—…è¡Œ", "æµ·å¤–æ—…è¡Œ", "ä¸€äººæ—…", "ã‚­ãƒ£ãƒ³ãƒ—", "æ¸©æ³‰å·¡ã‚Š", "ç¥ç¤¾ä»é–£å·¡ã‚Š"],
            "ğŸ¤ äºº": ["äº¤æµä¼š", "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢", "åœ°åŸŸæ´»å‹•", "ã‚³ãƒ¼ãƒãƒ³ã‚°", "å­è‚²ã¦"],
            "ğŸŒ¿ ãã®ä»–": ["ç‘æƒ³", "å ã„", "ãã®ä»–"]
        };
        const skillCategories = {
            "ğŸ’» IT": ["Webåˆ¶ä½œ", "WordPress", "Firebase", "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰", "ã‚¢ãƒ—ãƒªé–‹ç™º", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "ãƒ‡ãƒ¼ã‚¿åˆ†æ", "AIæ´»ç”¨"],
            "ğŸ¤ ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³": ["ãƒ—ãƒ¬ã‚¼ãƒ³", "ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "è¬›å¸«", "ã‚³ãƒ¼ãƒãƒ³ã‚°", "å–¶æ¥­", "äº¤æ¸‰", "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼"],
            "âœï¸ ç™ºä¿¡": ["ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°", "SNSé‹ç”¨", "ãƒ–ãƒ­ã‚°é‹å–¶", "å‹•ç”»ç·¨é›†", "ãƒ‡ã‚¶ã‚¤ãƒ³"],
            "ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹": ["èµ·æ¥­", "çµŒå–¶", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "ä¼šè¨ˆ", "äººäº‹", "è‹±èª"],
            "ğŸ§˜ ãã®ä»–": ["æ–™ç†æŒ‡å°", "æ•´ç†åç´", "å¥åº·ç®¡ç†"]
        };
        const prefectures = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ","æµ·å¤–","ãã®ä»–"];

        // Init
        const adminMockData = {
            userId: 'admin',
            name: 'ãƒ†ã‚¹ãƒˆç®¡ç†è€…',
            nameKana: 'ã¦ã™ã¨ã‹ã‚“ã‚Šã—ã‚ƒ',
            jobTitle: 'ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼',
            gender: 'ç”·æ€§',
            profilePublic: "true",
            hobbies: ['ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°'],
            skills: ['Webåˆ¶ä½œ'],
            email: 'admin@example.com',
            photoURL: ''
        };

        if (localStorage.getItem('isAdminMock') === 'true') {
            currentUser = { uid: 'test_admin_uid' };
            isAdmin = true;
            // Admin mock mode: targetUid is irrelevant for saving as it's mock
            currentUserData = adminMockData;
            initUI();
            populateForm(currentUserData);
            document.getElementById('admin-label').classList.remove('hidden');
        } else {
            onAuthStateChanged(auth, async (user) => {
                if (user && !user.isAnonymous) {
                    currentUser = user;
                    
                    // 1. ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ (è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚’èª­ã‚“ã§ userId == 'admin' ã‹ç¢ºèª)
                    const myProfileSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'));
                    if (myProfileSnap.exists() && myProfileSnap.data().userId === 'admin') {
                        isAdmin = true;
                        document.getElementById('admin-label').classList.remove('hidden');
                    }

                    // 2. ç·¨é›†å¯¾è±¡ã®æ±ºå®š
                    const urlParams = new URLSearchParams(window.location.search);
                    const paramUid = urlParams.get('uid');

                    if (paramUid && paramUid !== user.uid) {
                        // ä»–äººã®ç·¨é›†ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                        if (isAdmin) {
                            targetUid = paramUid;
                            showNotification('ç®¡ç†è€…æ¨©é™ã§ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç·¨é›†ã—ã¾ã™', 'info');
                        } else {
                            alert('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                            window.location.href = 'user.html';
                            return;
                        }
                    } else {
                        // è‡ªåˆ†ã®ç·¨é›†
                        targetUid = user.uid;
                    }

                    initUI();
                    await loadUserProfile(targetUid);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        function initUI() {
            renderFormOptions();
            const select = document.getElementById('prefecture-select');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            prefectures.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                select.appendChild(opt);
            });
        }

        async function loadUserProfile(uid) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                } else {
                    currentUserData = { userId: uid };
                }
                populateForm(currentUserData);
            } catch (e) {
                console.error(e);
                showNotification('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
            }
        }

        function renderFormOptions() {
            renderCategorySection('hobbies-container', hobbyCategories, 'hobbies');
            renderCategorySection('skills-container', skillCategories, 'skills');
        }

        function renderCategorySection(containerId, categoriesData, inputName) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for (const [category, items] of Object.entries(categoriesData)) {
                const details = document.createElement('details');
                details.className = 'group border border-gray-200 rounded-lg bg-white overflow-hidden';
                details.innerHTML = `
                    <summary class="flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50 bg-gray-50 transition-colors select-none">
                        <span class="font-bold text-gray-700 text-sm">${category}</span>
                        <span class="accordion-arrow text-gray-400"><i class="fa-solid fa-chevron-down"></i></span>
                    </summary>
                    <div class="p-4 border-t border-gray-100 flex flex-wrap gap-2"></div>`;
                const contentDiv = details.querySelector('div');
                items.forEach(item => {
                    contentDiv.innerHTML += `
                        <label class="cursor-pointer">
                            <input type="checkbox" name="${inputName}" value="${item}" class="tag-checkbox hidden">
                            <div class="px-3 py-1.5 rounded-full border border-gray-300 text-sm text-gray-600 hover:bg-gray-100 transition-colors select-none">${item}</div>
                        </label>`;
                });
                container.appendChild(details);
            }
        }

        function populateForm(data) {
            const form = document.getElementById('profile-form');
            if (!data) return;
            const fields = ['name', 'nameKana', 'gender', 'birthDate', 'birthVisibility', 'bio', 'contactEmail', 'websiteUrl', 'snsInstagram', 'snsX', 'prefecture', 'city', 'hobbyOtherText', 'skillDescription', 'message', 'goals', 'profilePublic', 'jobTitle', 'canOffer', 'lookingFor'];
            fields.forEach(f => { if (form[f] && data[f]) form[f].value = data[f]; });

            const img = document.getElementById('edit-icon-preview');
            const ph = document.getElementById('edit-icon-placeholder');
            if (data.photoURL) {
                img.src = data.photoURL;
                img.classList.remove('hidden');
                ph.classList.add('hidden');
            }

            const checkboxes = form.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                if (data[cb.name] && data[cb.name].includes(cb.value)) {
                    cb.checked = true;
                    cb.closest('details').open = true;
                }
            });

            const careerList = document.getElementById('career-list');
            careerList.innerHTML = '';
            if (data.career && Array.isArray(data.career)) {
                data.career.forEach(c => addCareerField(c));
            } else {
                addCareerField();
            }
        }

        window.addCareerField = (data = {}) => {
            const container = document.getElementById('career-list');
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded border border-gray-200 relative career-item';
            div.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                    <input type="text" placeholder="ä¼šç¤¾åãƒ»çµ„ç¹”å" class="career-company w-full border-gray-300 rounded p-2 text-sm" value="${data.company || ''}">
                    <input type="text" placeholder="å½¹è·ãƒ»å½¹å‰²" class="career-role w-full border-gray-300 rounded p-2 text-sm" value="${data.role || ''}">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <input type="month" class="career-start w-full border-gray-300 rounded p-2 text-sm" value="${data.start || ''}">
                    <input type="month" class="career-end w-full border-gray-300 rounded p-2 text-sm" value="${data.end || ''}">
                </div>
                <textarea placeholder="è©³ç´°ï¼ˆæ¥­å‹™å†…å®¹ãªã©ï¼‰" class="career-desc w-full border-gray-300 rounded p-2 text-sm" rows="2">${data.description || ''}</textarea>
            `;
            container.appendChild(div);
        };

        // Icon Preview
        document.getElementById('icon-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('edit-icon-preview');
                    const ph = document.getElementById('edit-icon-placeholder');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    ph.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        window.saveProfile = async () => {
            if (!currentUser) return;
            showNotification('ä¿å­˜ä¸­...', 'info');

            const form = document.getElementById('profile-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Image Upload
            const iconFile = document.getElementById('icon-upload').files[0];
            let photoURL = currentUserData.photoURL || null;
            if (iconFile && currentUser.uid !== 'test_admin_uid') {
                try {
                    // â˜…ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®UIDãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ï¼ˆç®¡ç†è€…ãŒä»–äººã®ç”»åƒã‚’å¤‰ãˆã‚‹å ´åˆã‚‚ãã®äººã®ãƒ•ã‚©ãƒ«ãƒ€ã¸ï¼‰
                    const storagePath = `users/${targetUid}/profile_icon.jpg`;
                    const storageRef = ref(storage, storagePath);
                    const snapshot = await uploadBytes(storageRef, iconFile);
                    photoURL = await getDownloadURL(snapshot.ref);
                } catch (e) {
                    console.error("Upload failed", e);
                }
            } else if (iconFile && currentUser.uid === 'test_admin_uid') {
                const reader = new FileReader();
                reader.readAsDataURL(iconFile); 
            }
            data.photoURL = photoURL;

            // Arrays
            const hobbies = [];
            form.querySelectorAll('input[name="hobbies"]:checked').forEach(cb => hobbies.push(cb.value));
            data.hobbies = hobbies;
            const skills = [];
            form.querySelectorAll('input[name="skills"]:checked').forEach(cb => skills.push(cb.value));
            data.skills = skills;

            // Career
            const career = [];
            document.querySelectorAll('.career-item').forEach(item => {
                const comp = item.querySelector('.career-company').value;
                if (comp) {
                    career.push({
                        company: comp,
                        role: item.querySelector('.career-role').value,
                        start: item.querySelector('.career-start').value,
                        end: item.querySelector('.career-end').value,
                        description: item.querySelector('.career-desc').value
                    });
                }
            });
            data.career = career;

            if(data.canOffer) data.canOffer = data.canOffer.split(',').map(s=>s.trim()).filter(s=>s);
            if(data.lookingFor) data.lookingFor = data.lookingFor.split(',').map(s=>s.trim()).filter(s=>s);

            // Calc Score
            let score = 0; let totalWeight = 0;
            const scoring = [{k:'name',w:10},{k:'jobTitle',w:10},{k:'prefecture',w:10},{k:'gender',w:5},{k:'contactEmail',w:5},{k:'birthDate',w:5},{k:'hobbies',w:10,isArr:true},{k:'skills',w:10,isArr:true},{k:'message',w:15},{k:'goals',w:15},{k:'canOffer',w:5,isArr:true},{k:'lookingFor',w:5,isArr:true},{k:'photoURL',w:10},{k:'bio',w:5}];
            scoring.forEach(item => {
                totalWeight += item.w;
                let filled = item.isArr ? (data[item.k] && data[item.k].length>0) : !!data[item.k];
                if(filled) score += item.w;
            });
            data.profileScore = Math.min(100, Math.round((score/totalWeight)*100));
            data.updatedAt = new Date().toISOString();

            const finalData = { ...currentUserData, ...data };

            if (currentUser.uid === 'test_admin_uid') {
                showNotification('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ(ãƒ†ã‚¹ãƒˆ)', 'success');
                setTimeout(() => window.location.href = 'user.html', 1000);
                return;
            }

            try {
                // 1. Private Master Data (â˜…targetUidã«å¯¾ã—ã¦ä¿å­˜)
                await setDoc(doc(db, 'artifacts', appId, 'users', targetUid, 'profile', 'data'), finalData);
                
                // 2. Public Search Index (â˜…targetUidã«å¯¾ã—ã¦ä¿å­˜)
                const publicDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', targetUid);
                
                if (data.profilePublic === 'true') {
                    const publicData = {
                        userId: finalData.userId,
                        name: finalData.name,
                        jobTitle: finalData.jobTitle,
                        gender: finalData.gender || null,
                        prefecture: finalData.prefecture,
                        hobbies: finalData.hobbies,
                        skills: finalData.skills,
                        canOffer: finalData.canOffer,
                        lookingFor: finalData.lookingFor,
                        photoURL: finalData.photoURL,
                        updatedAt: finalData.updatedAt,
                        // ä»–ã®è©³ç´°æƒ…å ±ã‚‚å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ”ãƒ¼
                        contactEmail: finalData.contactEmail,
                        snsX: finalData.snsX,
                        snsInstagram: finalData.snsInstagram,
                        websiteUrl: finalData.websiteUrl,
                        message: finalData.message,
                        bio: finalData.bio,
                        goals: finalData.goals,
                        career: finalData.career,
                        nameKana: finalData.nameKana,
                        birthDate: finalData.birthDate,
                        birthVisibility: finalData.birthVisibility,
                        // IDãƒ­ã‚°ã‚¤ãƒ³ç”¨
                        email: finalData.email 
                    };
                    await setDoc(publicDocRef, publicData, { merge: true });
                } else {
                    const minimalData = {
                        userId: finalData.userId,
                        email: finalData.email,
                        isHidden: true 
                    };
                    await setDoc(publicDocRef, minimalData);
                    console.log("Hidden from public search");
                }

                showNotification('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                // ç·¨é›†ã—ã¦ã„ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                setTimeout(() => window.location.href = `user.html?uid=${targetUid}`, 1000);

            } catch (e) {
                console.error("Save error details:", e);
                let errorMsg = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (e.code === 'permission-denied') {
                    errorMsg += ': æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                }
                showNotification(errorMsg, 'error');
            }
        };

        window.showNotification = (msg, type) => {
            const notif = document.getElementById('notification');
            const msgEl = document.getElementById('notif-message');
            notif.classList.remove('hidden', 'border-blue-500', 'border-red-500', 'border-green-500');
            if(type === 'error') notif.classList.add('border-red-500', 'text-red-700');
            else if (type === 'success') notif.classList.add('border-green-500', 'text-green-700');
            else notif.classList.add('border-blue-500', 'text-blue-700');
            msgEl.textContent = msg;
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 3000);
        };
    </script>
</body>
</html>
