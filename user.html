<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール | BRAIN BRIDGE</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #ffffff; color: #0f1419; }
        /* アプリライクなボーダーレイアウト */
        .app-layout { max-width: 1000px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        @media (min-width: 1024px) {
            .app-layout { flex-direction: row; border-left: 1px solid #eff3f4; border-right: 1px solid #eff3f4; }
            .sidebar { width: 350px; position: sticky; top: 0; height: 100vh; overflow-y: auto; border-right: 1px solid #eff3f4; }
            .main-content { flex: 1; }
        }
        .cover-image { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
        .shimmer { animation: shimmer 2s infinite linear; background: linear-gradient(to right, #f3f4f6 4%, #e5e7eb 25%, #f3f4f6 36%); background-size: 1000px 100%; }
        @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
        /* スクロールバー非表示 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <!-- Navbar (Mobile Only) -->
    <nav class="glass-nav border-b border-gray-100 fixed w-full z-50 top-0 lg:hidden">
        <div class="px-4 h-14 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="javascript:history.back()" class="text-gray-600 hover:bg-gray-100 p-2 rounded-full transition-colors">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <div>
                    <h1 class="font-bold text-lg leading-tight" id="nav-name">読み込み中...</h1>
                    <p class="text-xs text-gray-500" id="nav-id">Profile</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="location.reload()" class="p-2 text-gray-500 hover:text-blue-600 hover:bg-gray-100 rounded-full transition-all">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                <button onclick="handleLogout()" class="p-2 text-gray-500 hover:text-red-600 rounded-full">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="app-layout pt-14 lg:pt-0">
        
        <!-- Left Column: Basic Info (PC: Sticky Sidebar) -->
        <aside class="sidebar bg-white lg:py-8 lg:px-6">
            <div class="relative pb-4 lg:pb-0">
                <div class="h-32 lg:h-40 cover-image w-full lg:rounded-xl"></div>
                
                <div class="px-4 lg:px-2 relative">
                    <!-- Icon & Actions -->
                    <div class="-mt-12 mb-3 flex justify-between items-end">
                        <div class="h-24 w-24 rounded-full border-4 border-white bg-white overflow-hidden relative shadow-sm">
                            <i id="header-icon-placeholder" class="fa-solid fa-user text-4xl text-gray-300 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
                            <img id="header-icon-img" src="" class="hidden w-full h-full object-cover" alt="Profile">
                        </div>
                        <div id="header-actions" class="mb-2"></div>
                    </div>

                    <!-- Name & ID -->
                    <div class="mb-2">
                        <h1 class="text-xl font-extrabold text-gray-900 leading-tight">
                            <span id="profile-name" class="shimmer block w-32 h-6 rounded mb-1"></span>
                        </h1>
                        <p class="text-sm text-gray-500" id="profile-id">@...</p>
                        <span id="mutual-badge" class="hidden mt-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">
                            <i class="fa-solid fa-handshake mr-1.5 text-gray-400"></i>相互フォロー
                        </span>
                    </div>

                    <!-- Bio (Public) -->
                    <div class="mb-4">
                        <p id="profile-bio" class="text-[15px] text-gray-900 leading-relaxed whitespace-pre-wrap"></p>
                    </div>

                    <!-- Stats -->
                    <div class="flex items-center gap-4 text-sm mb-4">
                        <div class="hover:underline cursor-pointer">
                            <span class="font-bold text-gray-900" id="count-following">-</span>
                            <span class="text-gray-500">フォロー中</span>
                        </div>
                        <div class="hover:underline cursor-pointer">
                            <span class="font-bold text-gray-900" id="count-followers">-</span>
                            <span class="text-gray-500">フォロワー</span>
                        </div>
                    </div>

                    <!-- Basic Profile List -->
                    <div class="space-y-2 text-sm text-gray-600 mb-6">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-suitcase w-4 text-center text-gray-400"></i>
                            <span id="profile-job">-</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-location-dot w-4 text-center text-gray-400"></i>
                            <span id="profile-location">-</span>
                        </div>
                        <!-- Restricted Basics -->
                        <div class="mutual-only hidden space-y-2">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-venus-mars w-4 text-center text-gray-400"></i>
                                <span id="data-gender">-</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-cake-candles w-4 text-center text-gray-400"></i>
                                <span id="data-birth">-</span>
                            </div>
                        </div>
                        <div id="profile-sns-links" class="flex gap-3 pt-2"></div>
                    </div>

                    <!-- Completion Bar (Self Only) -->
                    <div id="completion-bar-container" class="hidden mb-6 p-4 bg-blue-50 rounded-xl">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-blue-800">プロフィール充実度</span>
                            <span id="score-text" class="text-xs font-bold text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-1.5">
                            <div id="score-bar" class="bg-blue-600 h-1.5 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- PC用ログアウトボタン -->
                    <div class="hidden lg:block mt-8 border-t border-gray-100 pt-6">
                        <button onclick="handleLogout()" class="flex items-center gap-3 text-gray-500 hover:text-red-600 transition-colors w-full font-bold">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            ログアウト
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Right Column: Main Content -->
        <div class="main-content bg-white pb-20">
            
            <!-- Message (Mutual Only) -->
            <div class="px-4 py-6 border-b border-gray-100">
                <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide flex items-center justify-between">
                    想い・メッセージ
                    <i id="message-lock-icon" class="fa-solid fa-lock text-gray-300 hidden"></i>
                </h3>
                
                <div id="message-container" class="hidden">
                    <p id="profile-message" class="text-[15px] leading-relaxed whitespace-pre-wrap text-gray-900">...</p>
                </div>

                <div id="message-mask" class="hidden mt-2 p-6 bg-gray-50 rounded-xl text-center border border-gray-100">
                    <p class="text-xs text-gray-500 font-medium">相互フォローで想いを読む</p>
                </div>
            </div>

            <!-- Tags -->
            <div class="px-4 py-6 border-b border-gray-100">
                <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wide">スキル・趣味</h3>
                <div id="tags-container" class="flex flex-wrap gap-2">
                    <span class="text-sm text-gray-400 italic">未設定</span>
                </div>
            </div>

            <!-- Matching -->
            <div class="px-4 py-6 border-b border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 mb-3">
                            <span class="bg-blue-100 text-blue-600 w-6 h-6 flex items-center justify-center rounded-full text-xs"><i class="fa-solid fa-hand-holding-heart"></i></span>
                            提供できること
                        </h3>
                        <ul id="list-can-offer" class="space-y-2 text-sm text-gray-700">
                            <li class="text-gray-400 italic">未設定</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="flex items-center gap-2 text-sm font-bold text-gray-900 mb-3">
                            <span class="bg-pink-100 text-pink-600 w-6 h-6 flex items-center justify-center rounded-full text-xs"><i class="fa-solid fa-magnifying-glass"></i></span>
                            求めていること
                        </h3>
                        <ul id="list-looking-for" class="space-y-2 text-sm text-gray-700">
                            <li class="text-gray-400 italic">未設定</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Goals -->
            <div class="px-4 py-6 border-b border-gray-100">
                <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wide">今後やりたいこと・目標</h3>
                <p id="profile-goals" class="text-sm text-gray-900 leading-relaxed whitespace-pre-wrap">未設定</p>
            </div>

            <!-- Career -->
            <div class="px-4 py-6">
                <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-wide flex items-center justify-between">
                    経歴
                    <i id="career-lock-icon" class="fa-solid fa-lock text-gray-300"></i>
                </h3>
                
                <div id="career-container" class="space-y-6">
                    <!-- JS injected -->
                </div>

                <div id="career-mask" class="hidden py-8 text-center bg-gray-50 rounded-xl border border-gray-100">
                    <p class="text-xs text-gray-500 font-medium">相互フォローで経歴を表示</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 hidden transition-all duration-300 translate-y-20">
        <div class="bg-gray-900 text-white px-5 py-2.5 rounded-full shadow-xl flex items-center gap-3">
            <i class="fa-solid fa-check text-green-400"></i>
            <span id="notif-message" class="text-sm font-bold"></span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, serverTimestamp, collection, getCountFromServer, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ▼▼▼▼ Firebase Config ▼▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';

        let currentUser = null;
        let isSelf = false;
        let targetUid = null;
        let isFollowing = false;
        let isMutual = false;

        const isAdminMock = localStorage.getItem('isAdminMock') === 'true';
        const urlParams = new URLSearchParams(window.location.search);
        targetUid = urlParams.get('uid');

        // Main Auth Logic
        onAuthStateChanged(auth, async (user) => {
            if (isAdminMock) {
                currentUser = { uid: 'test_admin_uid', displayName: '管理者' };
                if (targetUid && targetUid !== 'test_admin_uid') {
                    isSelf = false;
                    setupViewForOtherUser();
                } else {
                    isSelf = true;
                    targetUid = 'test_admin_uid';
                    updateDashboardUI(getAdminMockData());
                    enableSelfMode();
                }
                return;
            }

            if (user && !user.isAnonymous) {
                currentUser = user;
                
                if (!targetUid || targetUid === user.uid) {
                    isSelf = true;
                    targetUid = user.uid;
                    enableSelfMode();
                    await loadFullProfile(user.uid);
                } else {
                    isSelf = false;
                    await checkFollowStatus(user.uid, targetUid); 
                    await loadPublicProfile(targetUid);
                }
                updateFollowCounts(targetUid);
            } else {
                window.location.href = 'login.html';
            }
        });

        function enableSelfMode() {
            const headerActions = document.getElementById('header-actions');
            headerActions.innerHTML = `
                <a href="profile.html" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-bold rounded-full text-gray-900 bg-white hover:bg-gray-50 transition-colors w-full justify-center lg:w-auto">
                    プロフィール編集
                </a>`;
            document.getElementById('completion-bar-container').classList.remove('hidden');
            isMutual = true; 
            toggleRestrictedContent(true);
        }

        async function setupViewForOtherUser() {
            const mockTarget = getAdminMockData();
            mockTarget.name = "サンプル太郎";
            mockTarget.userId = "target_user";
            
            isMutual = confirm("【テスト】相互フォロー状態にしますか？\nOK=相互(全表示), Cancel=片思い/未フォロー");
            isFollowing = true;
            
            renderFollowButton();
            updateDashboardUI(mockTarget);
            toggleRestrictedContent(isMutual);
            if(isMutual) document.getElementById('mutual-badge').classList.remove('hidden');
            
            document.getElementById('count-following').textContent = '120';
            document.getElementById('count-followers').textContent = '45';
        }

        async function loadFullProfile(uid) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    updateDashboardUI(docSnap.data());
                } else {
                    updateDashboardUI({ userId: uid, name: '（未設定）' });
                }
            } catch (e) {
                console.error("Load self profile error", e);
                showNotification('データの読み込みに失敗しました');
            }
        }

        async function loadPublicProfile(uid) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    updateDashboardUI(docSnap.data());
                } else {
                    alert('ユーザーが見つかりません');
                    window.location.href = 'user.html'; 
                }
            } catch (e) {
                console.error("Load public profile error", e);
            }
        }

        async function updateFollowCounts(uid) {
            try {
                const followingColl = collection(db, 'artifacts', appId, 'users', uid, 'following');
                const followersColl = collection(db, 'artifacts', appId, 'users', uid, 'followers');
                
                const followingSnap = await getCountFromServer(followingColl);
                const followersSnap = await getCountFromServer(followersColl);
                
                document.getElementById('count-following').textContent = followingSnap.data().count;
                document.getElementById('count-followers').textContent = followersSnap.data().count;
            } catch (e) {
                console.error("Count error:", e);
                document.getElementById('count-following').textContent = '-';
                document.getElementById('count-followers').textContent = '-';
            }
        }

        async function checkFollowStatus(myUid, targetUid) {
            try {
                const followingRef = doc(db, 'artifacts', appId, 'users', myUid, 'following', targetUid);
                const isFollowingSnap = await getDoc(followingRef);
                isFollowing = isFollowingSnap.exists();

                const followerRef = doc(db, 'artifacts', appId, 'users', myUid, 'followers', targetUid);
                const isFollowedBackSnap = await getDoc(followerRef);
                const isFollowedBack = isFollowedBackSnap.exists();

                isMutual = isFollowing && isFollowedBack;
                renderFollowButton();
                
                const badge = document.getElementById('mutual-badge');
                if (isMutual && !isSelf) badge.classList.remove('hidden');
                else badge.classList.add('hidden');

                toggleRestrictedContent(isMutual);

                if (isMutual) {
                    try {
                        const privateRef = doc(db, 'artifacts', appId, 'users', targetUid, 'profile', 'data');
                        const privateSnap = await getDoc(privateRef);
                        if (privateSnap.exists()) {
                            const publicData = (await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', targetUid))).data();
                            const mergedData = { ...publicData, ...privateSnap.data() };
                            updateDashboardUI(mergedData);
                        }
                    } catch (e) {
                        console.log("Mutual data load failed:", e);
                    }
                }

            } catch (e) {
                console.error("Follow check error", e);
            }
        }

        function renderFollowButton() {
            const container = document.getElementById('header-actions');
            let btnHtml = '';
            
            if (isFollowing) {
                btnHtml = `
                    <button onclick="toggleFollow()" class="w-full lg:w-auto inline-flex justify-center items-center px-5 py-2 border border-gray-300 shadow-sm text-sm font-bold rounded-full text-gray-900 bg-white hover:bg-gray-50 transition-all">
                        フォロー中
                    </button>`;
            } else {
                btnHtml = `
                    <button onclick="toggleFollow()" class="w-full lg:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-sm font-bold rounded-full text-white bg-gray-900 hover:bg-gray-800 transition-all">
                        フォロー
                    </button>`;
            }
            container.innerHTML = btnHtml;
        }

        window.toggleFollow = async () => {
            if (!currentUser || isAdminMock) {
                if(isAdminMock) { isFollowing = !isFollowing; renderFollowButton(); showNotification('Mock Action'); }
                return;
            }
            
            const myUid = currentUser.uid;
            const myFollowingRef = doc(db, 'artifacts', appId, 'users', myUid, 'following', targetUid);
            const targetFollowerRef = doc(db, 'artifacts', appId, 'users', targetUid, 'followers', myUid);
            const notificationColl = collection(db, 'artifacts', appId, 'users', targetUid, 'notifications');

            try {
                if (isFollowing) {
                    await deleteDoc(myFollowingRef);
                    await deleteDoc(targetFollowerRef);
                    isFollowing = false;
                    showNotification('フォローを解除しました');
                } else {
                    const timestamp = serverTimestamp();
                    await setDoc(myFollowingRef, { createdAt: timestamp });
                    await setDoc(targetFollowerRef, { createdAt: timestamp });
                    
                    await addDoc(notificationColl, {
                        type: 'follow',
                        fromUid: myUid,
                        createdAt: timestamp,
                        isRead: false
                    });

                    isFollowing = true;
                    showNotification('フォローしました');
                }
                
                await checkFollowStatus(myUid, targetUid);
                updateFollowCounts(targetUid);

            } catch (e) {
                console.error(e);
                showNotification('エラーが発生しました');
            }
        };

        function toggleRestrictedContent(show) {
            const masks = ['message-mask', 'career-mask'];
            
            document.querySelectorAll('.mutual-only').forEach(el => {
                if(show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });

            if (show) {
                document.getElementById('message-container').classList.remove('hidden');
                document.getElementById('message-lock-icon').classList.add('hidden');
                document.getElementById('career-container').classList.remove('hidden');
                document.getElementById('career-lock-icon').classList.add('hidden');
                masks.forEach(id => document.getElementById(id)?.classList.add('hidden'));
            } else {
                document.getElementById('message-container').classList.add('hidden');
                document.getElementById('message-lock-icon').classList.remove('hidden');
                document.getElementById('career-container').classList.add('hidden');
                document.getElementById('career-lock-icon').classList.remove('hidden');
                masks.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
            }
        }

        function updateDashboardUI(data) {
            document.getElementById('nav-name').textContent = data.name || 'User';
            if (data.userId) document.getElementById('nav-id').textContent = '@' + data.userId;

            document.querySelectorAll('.shimmer').forEach(el => {
                el.classList.remove('shimmer', 'w-32', 'h-6');
            });

            document.getElementById('profile-name').textContent = data.name || data.userId || '（名称未設定）';
            document.getElementById('profile-id').textContent = '@' + (data.userId || '-');
            document.getElementById('profile-job').textContent = data.jobTitle || '職業未設定';
            document.getElementById('profile-location').textContent = data.prefecture || '未設定';
            document.getElementById('profile-bio').textContent = data.bio || '';
            
            const iconImg = document.getElementById('header-icon-img');
            const iconPh = document.getElementById('header-icon-placeholder');
            if (data.photoURL) {
                iconImg.src = data.photoURL;
                iconImg.classList.remove('hidden');
                iconPh.classList.add('hidden');
            } else {
                iconImg.classList.add('hidden');
                iconPh.classList.remove('hidden');
            }

            // Message (Mutual Only)
            const messageEl = document.getElementById('profile-message');
            messageEl.textContent = data.message || 'まだメッセージがありません。';

            // SNS
            const snsContainer = document.getElementById('profile-sns-links');
            snsContainer.innerHTML = '';
            const showSns = isMutual || isSelf;
            if (showSns) {
                if (data.websiteUrl) snsContainer.innerHTML += `<a href="${data.websiteUrl}" target="_blank" class="text-gray-400 hover:text-blue-500 transition-colors"><i class="fa-solid fa-globe text-lg"></i></a>`;
                if (data.snsInstagram) snsContainer.innerHTML += `<a href="${data.snsInstagram.startsWith('http') ? data.snsInstagram : 'https://instagram.com/'+data.snsInstagram}" target="_blank" class="text-gray-400 hover:text-pink-500 transition-colors"><i class="fa-brands fa-instagram text-lg"></i></a>`;
                if (data.snsX) snsContainer.innerHTML += `<a href="${data.snsX.startsWith('http') ? data.snsX : 'https://twitter.com/'+data.snsX}" target="_blank" class="text-gray-400 hover:text-gray-900 transition-colors"><i class="fa-brands fa-x-twitter text-lg"></i></a>`;
            }

            const updateList = (id, items) => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                if (items && items.length > 0) {
                    items.forEach(item => {
                        el.innerHTML += `<li class="flex items-start gap-2"><i class="fa-solid fa-check text-blue-500 mt-1"></i><span>${item}</span></li>`;
                    });
                } else {
                    el.innerHTML = '<li class="text-gray-400 text-xs">未設定</li>';
                }
            };
            updateList('list-can-offer', data.canOffer);
            updateList('list-looking-for', data.lookingFor);

            document.getElementById('profile-goals').textContent = data.goals || '未設定';

            const tagsContainer = document.getElementById('tags-container');
            tagsContainer.innerHTML = '';
            const allTags = [...(data.hobbies || []), ...(data.skills || [])];
            if (allTags.length > 0) {
                allTags.forEach(tag => {
                    const span = document.createElement('span');
                    span.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700';
                    span.textContent = tag;
                    tagsContainer.appendChild(span);
                });
            } else {
                tagsContainer.innerHTML = '<span class="text-xs text-gray-400">タグ未設定</span>';
            }

            const showRestricted = isMutual || isSelf;
            toggleRestrictedContent(showRestricted);

            if (showRestricted) {
                document.getElementById('data-gender').textContent = data.gender || '-';
                
                let birthDisplay = '-';
                if (data.birthDate) {
                    if (data.birthVisibility === 'full' || isSelf) birthDisplay = data.birthDate; 
                    else if (data.birthVisibility === 'monthDay') birthDisplay = data.birthDate.substring(5);
                    else birthDisplay = '非公開';
                }
                document.getElementById('data-birth').textContent = birthDisplay;

                const careerContainer = document.getElementById('career-container');
                careerContainer.innerHTML = '';
                if (data.career && data.career.length > 0) {
                    data.career.forEach(c => {
                        careerContainer.innerHTML += `
                            <div class="relative pl-4 border-l-2 border-gray-100">
                                <div class="absolute -left-[5px] top-1.5 h-2.5 w-2.5 rounded-full bg-gray-300 ring-4 ring-white"></div>
                                <h4 class="font-bold text-gray-900 text-sm">${c.company || '会社名不明'}</h4>
                                <p class="text-xs text-gray-500 mb-1">${c.role || ''} <span class="ml-1 opacity-70">(${c.start || '?'} 〜 ${c.end || '現在'})</span></p>
                                <p class="text-sm text-gray-700 leading-relaxed">${c.description || ''}</p>
                            </div>
                        `;
                    });
                } else {
                    careerContainer.innerHTML = '<div class="text-gray-400 text-sm italic">経歴情報はありません</div>';
                }
            }

            if (isSelf) {
                const score = data.profileScore || 0;
                document.getElementById('score-text').textContent = score + '%';
                document.getElementById('score-bar').style.width = score + '%';
            }
        }

        window.handleLogout = () => {
            if (isAdminMock) {
                localStorage.removeItem('isAdminMock');
                window.location.href = 'login.html';
                return;
            }
            signOut(auth);
            window.location.href = 'login.html';
        };

        window.showNotification = (msg) => {
            const notif = document.getElementById('notification');
            const msgEl = document.getElementById('notif-message');
            
            notif.classList.remove('hidden', 'translate-y-20');
            msgEl.textContent = msg;
            
            setTimeout(() => {
                notif.classList.add('translate-y-20');
                setTimeout(() => notif.classList.add('hidden'), 300);
            }, 3000);
        };

        function getAdminMockData() {
            return {
                userId: 'admin', name: 'テスト管理者', jobTitle: 'システム開発', gender: '男性',
                profileScore: 90, hobbies: ['開発', 'デザイン'], skills: ['Firebase', 'HTML/CSS'], email: 'admin@test.com',
                prefecture: '東京都', message: '管理者アカウントです。\n相互フォロー状態の確認用テキストです。', bio: 'ここは誰でも見れる自己紹介エリアです。', goals: '使いやすいサービスを作ること',
                canOffer: ['技術相談', 'コードレビュー'], lookingFor: ['UI/UXデザイナー'], career: []
            };
        }
    </script>
</body>
</html>
