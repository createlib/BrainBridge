<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ユーザー検索 | BRAIN BRIDGE</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            900: '#312e81',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        /* スマホでの3列表示調整 */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        @media (min-width: 640px) {
            .card-grid { grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        }
        @media (min-width: 1024px) {
            .card-grid { grid-template-columns: repeat(5, 1fr); gap: 1.5rem; }
        }
    </style>
</head>
<body class="text-slate-800 antialiased min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="glass-header border-b border-slate-200 fixed w-full z-50 top-0 h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="user.html" class="text-slate-500 hover:text-slate-900 transition-colors">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </a>
                <span class="font-bold text-lg">探す</span>
            </div>
            
            <!-- Search Bar (Desktop) -->
            <div class="hidden sm:block flex-1 max-w-md mx-8">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="desktop-search" placeholder="キーワードで検索 (名前, ID, 職業...)" 
                        class="w-full bg-slate-100 border-none rounded-full py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-brand-500 transition-all">
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="toggleFilters()" class="p-2 text-slate-600 hover:bg-slate-100 rounded-full transition-colors relative">
                    <i class="fa-solid fa-sliders"></i>
                    <span id="filter-badge" class="hidden absolute top-1 right-1 w-2 h-2 bg-brand-500 rounded-full"></span>
                </button>
                <a href="user.html" class="p-2 text-slate-400 hover:text-brand-600 transition-colors">
                    <i class="fa-solid fa-user"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Search Bar (Mobile) -->
    <div class="sm:hidden fixed top-16 w-full bg-white/95 backdrop-blur-sm z-40 px-4 py-2 border-b border-slate-100">
        <div class="relative">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="mobile-search" placeholder="キーワードで検索" 
                class="w-full bg-slate-100 border-none rounded-xl py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-brand-500">
        </div>
    </div>

    <!-- Filter Panel -->
    <div id="filter-panel" class="fixed top-0 left-0 w-full h-full bg-black/50 z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="absolute right-0 top-0 h-full w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col" id="filter-content">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg">フィルター</h3>
                <button onclick="toggleFilters()" class="p-2 text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="p-6 flex-1 overflow-y-auto space-y-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">エリア (都道府県)</label>
                    <select id="filter-prefecture" class="w-full border-slate-200 rounded-lg text-sm p-2.5 focus:border-brand-500 focus:ring-brand-500">
                        <option value="">すべて</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">職業・肩書</label>
                    <input type="text" id="filter-job" placeholder="例: エンジニア" class="w-full border-slate-200 rounded-lg text-sm p-2.5">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">並び順</label>
                    <select id="filter-sort" class="w-full border-slate-200 rounded-lg text-sm p-2.5">
                        <option value="random">ランダム</option>
                        <option value="newest">新着順</option>
                    </select>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50">
                <button onclick="applyFilters()" class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl hover:bg-brand-700 transition-colors shadow-sm">
                    検索結果を表示
                </button>
                <button onclick="resetFilters()" class="w-full mt-2 text-sm text-slate-500 hover:text-slate-800 py-2">
                    リセット
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl mx-auto w-full pt-32 sm:pt-24 px-3 pb-20">
        
        <div id="loading-indicator" class="flex justify-center py-12">
            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-brand-500"></i>
        </div>

        <div id="users-grid" class="card-grid hidden"></div>

        <div id="no-results" class="hidden text-center py-20">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4 text-slate-400">
                <i class="fa-solid fa-users-slash text-2xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-900 mb-1">ユーザーが見つかりません</h3>
            <p class="text-slate-500 text-sm">検索条件を変えて試してみてください</p>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ▼▼▼▼ Firebase Config ▼▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'default-app-id';

        let allUsers = []; 
        let filteredUsers = [];

        const prefectures = ["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県","海外"];

        document.addEventListener('DOMContentLoaded', () => {
            initPrefectureSelect();
            fetchUsers();

            document.getElementById('desktop-search').addEventListener('input', (e) => filterUsers(e.target.value));
            document.getElementById('mobile-search').addEventListener('input', (e) => filterUsers(e.target.value));
        });

        function initPrefectureSelect() {
            const select = document.getElementById('filter-prefecture');
            prefectures.forEach(pref => {
                const option = document.createElement('option');
                option.value = pref;
                option.textContent = pref;
                select.appendChild(option);
            });
        }

        async function fetchUsers() {
            try {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const q = query(usersRef); 
                const snapshot = await getDocs(q);

                allUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // ★重要: システム用ID (Auth UID) を保持しておく
                    data.authUid = doc.id; 
                    
                    if (data.userId && data.name) {
                        allUsers.push(data);
                    }
                });

                shuffleArray(allUsers);
                filteredUsers = [...allUsers];
                
                renderGrid(filteredUsers);
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('users-grid').classList.remove('hidden');

            } catch (error) {
                console.error("Fetch users error:", error);
                document.getElementById('loading-indicator').innerHTML = '<p class="text-red-500">読み込みに失敗しました</p>';
            }
        }

        window.filterUsers = (keyword = "") => {
            const term = keyword.toLowerCase();
            document.getElementById('desktop-search').value = keyword;
            document.getElementById('mobile-search').value = keyword;

            const pref = document.getElementById('filter-prefecture').value;
            const job = document.getElementById('filter-job').value.toLowerCase();
            
            const hasFilter = pref || job;
            const badge = document.getElementById('filter-badge');
            if (hasFilter) badge.classList.remove('hidden');
            else badge.classList.add('hidden');

            filteredUsers = allUsers.filter(user => {
                const searchTarget = `${user.name} ${user.userId} ${user.jobTitle || ''} ${user.bio || ''} ${user.hobbies?.join(' ') || ''}`.toLowerCase();
                const matchKeyword = !term || searchTarget.includes(term);
                const matchPref = !pref || (user.prefecture === pref);
                const matchJob = !job || (user.jobTitle && user.jobTitle.toLowerCase().includes(job));
                return matchKeyword && matchPref && matchJob;
            });

            const sortType = document.getElementById('filter-sort').value;
            if (sortType === 'newest') {
                filteredUsers.sort((a, b) => (b.updatedAt || '').localeCompare(a.updatedAt || ''));
            }

            renderGrid(filteredUsers);
        };

        window.toggleFilters = () => {
            const panel = document.getElementById('filter-panel');
            const content = document.getElementById('filter-content');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                setTimeout(() => {
                    panel.classList.remove('opacity-0');
                    content.classList.remove('translate-x-full');
                }, 10);
            } else {
                panel.classList.add('opacity-0');
                content.classList.add('translate-x-full');
                setTimeout(() => {
                    panel.classList.add('hidden');
                }, 300);
            }
        };

        window.applyFilters = () => {
            const term = document.getElementById('desktop-search').value || document.getElementById('mobile-search').value;
            filterUsers(term);
            toggleFilters();
        };

        window.resetFilters = () => {
            document.getElementById('filter-prefecture').value = "";
            document.getElementById('filter-job').value = "";
            document.getElementById('filter-sort').value = "random";
            document.getElementById('desktop-search').value = "";
            document.getElementById('mobile-search').value = "";
            
            shuffleArray(allUsers);
            filterUsers("");
            toggleFilters();
        };

        function renderGrid(users) {
            const grid = document.getElementById('users-grid');
            const noResults = document.getElementById('no-results');
            grid.innerHTML = '';

            if (users.length === 0) {
                grid.classList.add('hidden');
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            grid.classList.remove('hidden');

            users.forEach(user => {
                const card = document.createElement('a');
                // ★修正箇所: user.userId ではなく user.authUid (システムID) をリンクに使う
                card.href = `user.html?uid=${user.authUid}`;
                card.className = "block bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-md hover:border-brand-200 transition-all duration-200 flex flex-col h-full";
                
                let iconHtml = '';
                if (user.photoURL) {
                    iconHtml = `<img src="${user.photoURL}" class="w-full h-full object-cover" loading="lazy">`;
                } else {
                    iconHtml = `<div class="w-full h-full bg-slate-50 flex items-center justify-center text-slate-300"><i class="fa-solid fa-user text-3xl"></i></div>`;
                }

                card.innerHTML = `
                    <div class="aspect-square w-full relative">
                        ${iconHtml}
                        ${user.prefecture ? `<span class="absolute bottom-1 right-1 bg-black/60 backdrop-blur-sm text-white text-[10px] px-1.5 py-0.5 rounded font-medium">${user.prefecture}</span>` : ''}
                    </div>
                    <div class="p-2 sm:p-3 flex-1 flex flex-col">
                        <h3 class="font-bold text-xs sm:text-sm text-slate-900 leading-tight truncate mb-0.5">${user.name}</h3>
                        <p class="text-[10px] sm:text-xs text-slate-400 truncate mb-1">@${user.userId}</p>
                        ${user.jobTitle ? `<p class="text-[10px] text-brand-600 bg-brand-50 px-1.5 py-0.5 rounded self-start truncate max-w-full">${user.jobTitle}</p>` : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
</body>
</html>
