<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ | BRAIN BRIDGE</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            900: '#312e81',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        /* ã‚¹ãƒãƒ›ã§ã®3åˆ—è¡¨ç¤ºèª¿æ•´ */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        @media (min-width: 640px) {
            .card-grid { grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        }
        @media (min-width: 1024px) {
            .card-grid { grid-template-columns: repeat(5, 1fr); gap: 1.5rem; }
        }
        
        /* Bottom Nav Safe Area */
        .pb-safe-bottom { padding-bottom: calc(4rem + env(safe-area-inset-bottom)); }
        
        /* Custom Checkbox */
        .filter-checkbox:checked + div {
            background-color: #eef2ff;
            border-color: #6366f1;
            color: #4f46e5;
        }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .accordion-arrow { transition: transform 0.2s ease; }
        details[open] .accordion-arrow { transform: rotate(180deg); }
    </style>
</head>
<body class="text-slate-800 antialiased min-h-screen flex flex-col pb-safe-bottom lg:pb-0">

    <!-- Navbar -->
    <nav class="glass-header border-b border-slate-200 fixed w-full z-50 top-0 h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="search.html" class="text-xl font-black text-slate-900 tracking-tight flex items-center gap-2">
                    <span class="bg-slate-900 text-white w-8 h-8 flex items-center justify-center rounded-lg text-sm">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </span>
                    <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</span>
                </a>
            </div>
            
            <!-- Search Bar (Desktop Only) -->
            <div class="hidden lg:block flex-1 max-w-md mx-8">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="desktop-search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ (åå‰, ID, è·æ¥­...)" 
                        class="w-full bg-slate-100 border-none rounded-full py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-brand-500 transition-all">
                </div>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center gap-3">
                <!-- PC Navigation Links -->
                <div class="hidden lg:flex items-center gap-6 mr-4">
                    <a href="home.html" class="text-slate-500 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm"><i class="fa-solid fa-house"></i> ãƒ›ãƒ¼ãƒ </a>
                    <a href="events.html" class="text-slate-500 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm"><i class="fa-solid fa-map-location-dot"></i> ã‚¤ãƒ™ãƒ³ãƒˆ</a>
                    <a href="search.html" class="text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm"><i class="fa-solid fa-magnifying-glass"></i> ã•ãŒã™</a>
                    <a href="user.html" class="text-slate-500 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm"><i class="fa-solid fa-user"></i> ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
                </div>

                <!-- Filter Button (Desktop Only) -->
                <button onclick="toggleFilters()" class="hidden lg:flex p-2 text-slate-600 hover:bg-slate-100 rounded-full transition-colors relative" title="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
                    <i class="fa-solid fa-sliders"></i>
                    <span id="filter-badge-desktop" class="hidden absolute top-1 right-1 w-2 h-2 bg-brand-500 rounded-full"></span>
                </button>
                
                <!-- Notification Bell -->
                <a href="notifications.html" class="p-2 text-slate-400 hover:text-brand-600 transition-colors">
                    <i class="fa-regular fa-bell text-xl"></i>
                </a>

                <!-- Logout (Desktop) -->
                <button onclick="handleLogout()" class="hidden lg:flex text-sm font-bold text-slate-500 hover:text-red-600 transition-colors flex items-center gap-2">
                    <span class="hidden sm:inline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                    <i class="fa-solid fa-right-from-bracket text-lg"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Search Bar & Filter (Mobile Only) -->
    <div class="lg:hidden fixed top-16 w-full bg-white/95 backdrop-blur-sm z-40 px-4 py-3 border-b border-slate-100 shadow-sm">
        <div class="flex gap-3">
            <div class="relative flex-1">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="mobile-search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" 
                    class="w-full bg-slate-100 border-none rounded-xl py-2.5 pl-10 pr-4 text-sm focus:ring-2 focus:ring-brand-500 transition-all">
            </div>
            <!-- Mobile Filter Button -->
            <button onclick="toggleFilters()" class="flex-shrink-0 w-11 h-11 bg-slate-100 rounded-xl flex items-center justify-center text-slate-600 hover:bg-slate-200 transition-colors relative">
                <i class="fa-solid fa-sliders"></i>
                <span id="filter-badge-mobile" class="hidden absolute top-2 right-2 w-2 h-2 bg-brand-500 rounded-full border border-white"></span>
            </button>
        </div>
    </div>

    <!-- Filter Panel -->
    <div id="filter-panel" class="fixed top-0 left-0 w-full h-full bg-black/50 z-[60] hidden opacity-0 transition-opacity duration-300">
        <div class="absolute right-0 top-0 h-full w-80 sm:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col" id="filter-content">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-filter text-brand-600"></i> çµã‚Šè¾¼ã¿
                </h3>
                <button onclick="toggleFilters()" class="p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-50">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                <!-- Sort -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">ä¸¦ã³é †</label>
                    <select id="filter-sort" class="w-full border-slate-200 rounded-lg text-sm p-2.5 bg-slate-50 focus:border-brand-500 focus:ring-brand-500">
                        <option value="random">ãŠã™ã™ã‚é †ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰</option>
                        <option value="newest">æ–°ç€é †</option>
                    </select>
                </div>
                <hr class="border-slate-100">
                <!-- Basic Profile -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-3">åŸºæœ¬æƒ…å ±</label>
                    <div class="space-y-3">
                        <div>
                            <span class="block text-sm font-medium text-slate-700 mb-1">ã‚¨ãƒªã‚¢ (éƒ½é“åºœçœŒ)</span>
                            <select id="filter-prefecture" class="w-full border-slate-200 rounded-lg text-sm p-2.5 focus:border-brand-500 focus:ring-brand-500">
                                <option value="">æŒ‡å®šãªã—</option>
                            </select>
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-slate-700 mb-1">æ€§åˆ¥</span>
                            <select id="filter-gender" class="w-full border-slate-200 rounded-lg text-sm p-2.5 focus:border-brand-500 focus:ring-brand-500">
                                <option value="">æŒ‡å®šãªã—</option>
                                <option value="ç”·æ€§">ç”·æ€§</option>
                                <option value="å¥³æ€§">å¥³æ€§</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-slate-700 mb-1">è·æ¥­ãƒ»è‚©æ›¸</span>
                            <input type="text" id="filter-job" placeholder="ä¾‹: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢" class="w-full border-slate-200 rounded-lg text-sm p-2.5">
                        </div>
                    </div>
                </div>
                <hr class="border-slate-100">
                <!-- Matching -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-3">ãƒãƒƒãƒãƒ³ã‚°</label>
                    <div class="space-y-3">
                        <div>
                            <span class="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-1"><i class="fa-solid fa-hand-holding-heart text-blue-500"></i> æä¾›ã§ãã‚‹ã“ã¨</span>
                            <input type="text" id="filter-can-offer" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: ãƒ‡ã‚¶ã‚¤ãƒ³)" class="w-full border-slate-200 rounded-lg text-sm p-2.5">
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-1"><i class="fa-solid fa-magnifying-glass text-pink-500"></i> æ±‚ã‚ã¦ã„ã‚‹ã“ã¨</span>
                            <input type="text" id="filter-looking-for" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: ç›¸è«‡)" class="w-full border-slate-200 rounded-lg text-sm p-2.5">
                        </div>
                    </div>
                </div>
                <hr class="border-slate-100">
                <!-- Skills & Hobbies (Accordion) -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-3">è©³ç´°ã‚¿ã‚°æ¤œç´¢</label>
                    <div class="space-y-3">
                        <details class="group bg-white border border-slate-200 rounded-lg overflow-hidden">
                            <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-slate-50 transition-colors select-none">
                                <span class="font-bold text-sm text-slate-700"><i class="fa-solid fa-laptop-code mr-2 text-slate-400"></i>ã‚¹ã‚­ãƒ«</span>
                                <span class="accordion-arrow text-slate-400"><i class="fa-solid fa-chevron-down"></i></span>
                            </summary>
                            <div class="p-3 border-t border-slate-100 bg-slate-50/50 max-h-60 overflow-y-auto" id="filter-skills-container"></div>
                        </details>
                        <details class="group bg-white border border-slate-200 rounded-lg overflow-hidden">
                            <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-slate-50 transition-colors select-none">
                                <span class="font-bold text-sm text-slate-700"><i class="fa-solid fa-icons mr-2 text-slate-400"></i>è¶£å‘³</span>
                                <span class="accordion-arrow text-slate-400"><i class="fa-solid fa-chevron-down"></i></span>
                            </summary>
                            <div class="p-3 border-t border-slate-100 bg-slate-50/50 max-h-60 overflow-y-auto" id="filter-hobbies-container"></div>
                        </details>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50 pb-safe-bottom">
                <button onclick="applyFilters()" class="w-full bg-brand-600 text-white font-bold py-3.5 rounded-xl hover:bg-brand-700 transition-colors shadow-lg shadow-brand-500/30">
                    æ¤œç´¢çµæœã‚’è¡¨ç¤º
                </button>
                <button onclick="resetFilters()" class="w-full mt-3 text-sm text-slate-500 hover:text-slate-800 py-2 font-medium">
                    æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl mx-auto w-full pt-32 lg:pt-24 px-3 pb-20">
        
        <div id="loading-indicator" class="flex flex-col items-center justify-center py-20">
            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-brand-500 mb-3"></i>
            <p class="text-slate-400 text-sm">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <div id="users-grid" class="card-grid hidden"></div>

        <div id="no-results" class="hidden text-center py-20">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-slate-100 mb-4 text-slate-400">
                <i class="fa-solid fa-users-slash text-3xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-900 mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
            <p class="text-slate-500 text-sm">æ¤œç´¢æ¡ä»¶ã‚’å¤‰ãˆã¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„</p>
            <button onclick="resetFilters()" class="mt-6 text-brand-600 font-bold text-sm hover:underline">
                ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤º
            </button>
        </div>

    </main>

    <!-- Bottom Navigation (Mobile Only) -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-200 lg:hidden z-40 safe-area-pb">
        <div class="flex justify-around items-center h-16">
            <a href="home.html" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                <span class="text-[10px] font-medium">ãƒ›ãƒ¼ãƒ </span>
            </a>
            <a href="events.html" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-map-location-dot text-xl mb-1"></i>
                <span class="text-[10px] font-medium">ã‚¤ãƒ™ãƒ³ãƒˆ</span>
            </a>
            <!-- Active Search -->
            <a href="search.html" class="flex flex-col items-center justify-center w-full h-full text-brand-600">
                <i class="fa-solid fa-magnifying-glass text-xl mb-1"></i>
                <span class="text-[10px] font-bold">ã•ãŒã™</span>
            </a>
            <button onclick="alert('ãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚\nComing Soon!')" class="flex flex-col items-center justify-center w-full h-full text-slate-300 hover:text-slate-400 transition-colors">
                <i class="fa-solid fa-handshake-simple text-xl mb-1"></i>
                <span class="text-[10px] font-medium">ãƒãƒƒãƒ</span>
            </button>
            <a href="user.html" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-user text-xl mb-1"></i>
                <span class="text-[10px] font-medium">ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, doc, getDoc, where, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // â–¼â–¼â–¼â–¼ Firebase Config â–¼â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';

        let allUsers = []; 
        let filteredUsers = [];
        let currentUser = null;
        let isAdmin = false; // ç®¡ç†è€…ãƒ•ãƒ©ã‚°

        const hobbyCategories = {
            "ğŸƒ ã‚¹ãƒãƒ¼ãƒ„ãƒ»é‹å‹•ç³»": ["ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°", "ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°", "ç­‹ãƒˆãƒ¬", "ãƒ¨ã‚¬", "ãƒ”ãƒ©ãƒ†ã‚£ã‚¹", "ãƒ€ãƒ³ã‚¹", "ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«", "ã‚µãƒƒã‚«ãƒ¼", "ãƒ•ãƒƒãƒˆã‚µãƒ«", "é‡çƒ", "ãƒ†ãƒ‹ã‚¹", "ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³", "å“çƒ", "ã‚´ãƒ«ãƒ•", "ãƒœãƒ«ãƒ€ãƒªãƒ³ã‚°", "ç™»å±±", "ã‚µãƒ¼ãƒ•ã‚£ãƒ³", "ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰", "ã‚¹ã‚­ãƒ¼", "ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°", "æ°´æ³³", "æ ¼é—˜æŠ€", "æ­¦é“"],
            "ğŸµ éŸ³æ¥½ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡": ["ã‚«ãƒ©ã‚ªã‚±", "æ¥½å™¨æ¼”å¥ï¼ˆã‚®ã‚¿ãƒ¼ï¼‰", "æ¥½å™¨æ¼”å¥ï¼ˆãƒ”ã‚¢ãƒï¼‰", "ä½œæ›²", "æ­Œ", "ãƒ©ã‚¤ãƒ–é‘‘è³", "ãƒ•ã‚§ã‚¹", "DJ", "æ˜ ç”»é‘‘è³", "ã‚¢ãƒ‹ãƒ¡é‘‘è³", "æ¼«ç”»", "ã‚²ãƒ¼ãƒ ", "ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ "],
            "ğŸ¨ æ–‡åŒ–ãƒ»ã‚¢ãƒ¼ãƒˆ": ["çµµç”»", "ã‚¤ãƒ©ã‚¹ãƒˆ", "ãƒ‡ã‚¶ã‚¤ãƒ³", "å†™çœŸæ’®å½±", "å‹•ç”»ç·¨é›†", "æ‰‹èŠ¸", "DIY", "å°èª¬åŸ·ç­†", "ãƒ–ãƒ­ã‚°"],
            "ğŸ“š å­¦ã³": ["èª­æ›¸", "è‡ªå·±å•“ç™º", "æ­´å²", "å¿ƒç†å­¦", "æŠ•è³‡", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "è‹±èªå­¦ç¿’", "è³‡æ ¼å–å¾—"],
            "ğŸ³ é£Ÿãƒ»æš®ã‚‰ã—": ["æ–™ç†", "ãŠè“å­ä½œã‚Š", "ã‚«ãƒ•ã‚§å·¡ã‚Š", "é£Ÿã¹æ­©ã", "ãŠé…’", "ã‚³ãƒ¼ãƒ’ãƒ¼", "ã‚¤ãƒ³ãƒ†ãƒªã‚¢", "ãƒŸãƒ‹ãƒãƒªã‚ºãƒ "],
            "âœˆï¸ æ—…è¡Œ": ["å›½å†…æ—…è¡Œ", "æµ·å¤–æ—…è¡Œ", "ä¸€äººæ—…", "ã‚­ãƒ£ãƒ³ãƒ—", "æ¸©æ³‰å·¡ã‚Š", "ç¥ç¤¾ä»é–£å·¡ã‚Š"],
            "ğŸ¤ äºº": ["äº¤æµä¼š", "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢", "åœ°åŸŸæ´»å‹•", "ã‚³ãƒ¼ãƒãƒ³ã‚°", "å­è‚²ã¦"],
            "ğŸŒ¿ ãã®ä»–": ["ç‘æƒ³", "å ã„", "ãã®ä»–"]
        };
        const skillCategories = {
            "ğŸ’» IT": ["Webåˆ¶ä½œ", "WordPress", "Firebase", "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰", "ã‚¢ãƒ—ãƒªé–‹ç™º", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "ãƒ‡ãƒ¼ã‚¿åˆ†æ", "AIæ´»ç”¨"],
            "ğŸ¤ ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³": ["ãƒ—ãƒ¬ã‚¼ãƒ³", "ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "è¬›å¸«", "ã‚³ãƒ¼ãƒãƒ³ã‚°", "å–¶æ¥­", "äº¤æ¸‰", "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼"],
            "âœï¸ ç™ºä¿¡": ["ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°", "SNSé‹ç”¨", "ãƒ–ãƒ­ã‚°é‹å–¶", "å‹•ç”»ç·¨é›†", "ãƒ‡ã‚¶ã‚¤ãƒ³"],
            "ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹": ["èµ·æ¥­", "çµŒå–¶", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "ä¼šè¨ˆ", "äººäº‹", "è‹±èª"],
            "ğŸ§˜ ãã®ä»–": ["æ–™ç†æŒ‡å°", "æ•´ç†åç´", "å¥åº·ç®¡ç†"]
        };
        const prefectures = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ","æµ·å¤–","ãã®ä»–"];

        document.addEventListener('DOMContentLoaded', () => {
            initFilterOptions();
            const dInput = document.getElementById('desktop-search');
            const mInput = document.getElementById('mobile-search');
            if (dInput) dInput.addEventListener('input', (e) => filterUsers(e.target.value));
            if (mInput) mInput.addEventListener('input', (e) => filterUsers(e.target.value));
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if (localStorage.getItem('isAdminMock') === 'true') {
                    isAdmin = true;
                    fetchUsers();
                    return;
                }
                
                try {
                    const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
                    const profileSnap = await getDoc(profileRef);
                    
                    if (profileSnap.exists()) {
                        const data = profileSnap.data();
                        const rank = data.membershipRank || 'walker';
                        
                        // ç®¡ç†è€…åˆ¤å®š
                        if (data.userId === 'admin') isAdmin = true;

                        // WALKERãƒã‚§ãƒƒã‚¯ (ç®¡ç†è€…ã¯å…é™¤)
                        if (rank === 'walker' && !isAdmin) {
                            alert('æ¤œç´¢æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚');
                            window.location.href = 'upgrade.html';
                            return;
                        }
                    }
                    fetchUsers();
                } catch (e) { console.error(e); fetchUsers(); }

            } else {
                window.location.href = 'login.html';
            }
        });

        function initFilterOptions() {
            const select = document.getElementById('filter-prefecture');
            prefectures.forEach(pref => {
                const option = document.createElement('option');
                option.value = pref;
                option.textContent = pref;
                select.appendChild(option);
            });
            const skillsContainer = document.getElementById('filter-skills-container');
            createCategoryCheckboxes(skillCategories, skillsContainer, 'filter-skill');
            const hobbiesContainer = document.getElementById('filter-hobbies-container');
            createCategoryCheckboxes(hobbyCategories, hobbiesContainer, 'filter-hobby');
        }

        function createCategoryCheckboxes(data, container, name) {
            for (const [category, items] of Object.entries(data)) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'mb-3';
                groupDiv.innerHTML = `<h5 class="text-xs font-bold text-slate-500 mb-1.5">${category}</h5>`;
                const flexDiv = document.createElement('div');
                flexDiv.className = 'flex flex-wrap gap-1.5';
                items.forEach(item => {
                    const label = document.createElement('label');
                    label.className = 'cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" name="${name}" value="${item}" class="filter-checkbox hidden">
                        <div class="px-2 py-1 rounded border border-slate-200 text-xs text-slate-600 hover:bg-slate-100 transition-colors select-none">${item}</div>
                    `;
                    flexDiv.appendChild(label);
                });
                groupDiv.appendChild(flexDiv);
                container.appendChild(groupDiv);
            }
        }

        async function fetchUsers() {
            try {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const q = query(usersRef); 
                const snapshot = await getDocs(q);

                allUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.authUid = doc.id; 
                    
                    // â˜…ä¿®æ­£: ç®¡ç†è€…ã¯isHiddenãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚è¡¨ç¤ºã™ã‚‹
                    // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ isHidden ãŒ false ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
                    const isVisible = !data.isHidden || isAdmin;

                    // â˜…ä¿®æ­£: data.userId ãŒã‚ã‚Œã°ã€åå‰ãŒãªãã¦ã‚‚ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚ã‚Šï¼‰
                    if (data.userId && isVisible) {
                        if (!data.name) data.name = "åç§°æœªè¨­å®š";
                        allUsers.push(data);
                    }
                });

                shuffleArray(allUsers);
                filteredUsers = [...allUsers];
                
                document.getElementById('loading-indicator').classList.add('hidden');
                renderGrid(filteredUsers);

            } catch (error) {
                console.error("Fetch users error:", error);
                document.getElementById('loading-indicator').innerHTML = '<p class="text-red-500">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        window.filterUsers = (keyword) => {
            const term = (typeof keyword === 'string' ? keyword : document.getElementById('desktop-search').value).toLowerCase();
            
            const dInput = document.getElementById('desktop-search');
            const mInput = document.getElementById('mobile-search');
            if (dInput && dInput.value !== term) dInput.value = term;
            if (mInput && mInput.value !== term) mInput.value = term;

            const pref = document.getElementById('filter-prefecture').value;
            const gender = document.getElementById('filter-gender').value;
            const job = document.getElementById('filter-job').value.toLowerCase();
            const canOffer = document.getElementById('filter-can-offer').value.toLowerCase();
            const lookingFor = document.getElementById('filter-looking-for').value.toLowerCase();
            
            const selectedSkills = Array.from(document.querySelectorAll('input[name="filter-skill"]:checked')).map(cb => cb.value);
            const selectedHobbies = Array.from(document.querySelectorAll('input[name="filter-hobby"]:checked')).map(cb => cb.value);

            const hasFilter = pref || gender || job || canOffer || lookingFor || selectedSkills.length > 0 || selectedHobbies.length > 0;
            const badgeD = document.getElementById('filter-badge-desktop');
            const badgeM = document.getElementById('filter-badge-mobile');
            if (hasFilter) {
                badgeD?.classList.remove('hidden');
                badgeM?.classList.remove('hidden');
            } else {
                badgeD?.classList.add('hidden');
                badgeM?.classList.add('hidden');
            }

            filteredUsers = allUsers.filter(user => {
                const searchTarget = `${user.name} ${user.userId} ${user.jobTitle || ''} ${user.bio || ''} ${user.hobbies?.join(' ') || ''}`.toLowerCase();
                const matchKeyword = !term || searchTarget.includes(term);
                const matchPref = !pref || (user.prefecture === pref);
                const matchGender = !gender || (user.gender === gender);
                const matchJob = !job || (user.jobTitle && user.jobTitle.toLowerCase().includes(job));
                const matchOffer = !canOffer || (user.canOffer && user.canOffer.some(item => item.toLowerCase().includes(canOffer)));
                const matchLooking = !lookingFor || (user.lookingFor && user.lookingFor.some(item => item.toLowerCase().includes(lookingFor)));
                
                const matchSkills = selectedSkills.length === 0 || (user.skills && selectedSkills.some(tag => user.skills.includes(tag)));
                const matchHobbies = selectedHobbies.length === 0 || (user.hobbies && selectedHobbies.some(tag => user.hobbies.includes(tag)));

                return matchKeyword && matchPref && matchGender && matchJob && matchOffer && matchLooking && matchSkills && matchHobbies;
            });

            const sortType = document.getElementById('filter-sort').value;
            if (sortType === 'newest') {
                filteredUsers.sort((a, b) => (b.updatedAt || '').localeCompare(a.updatedAt || ''));
            }

            renderGrid(filteredUsers);
        };

        window.toggleFilters = () => {
            const panel = document.getElementById('filter-panel');
            const content = document.getElementById('filter-content');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                setTimeout(() => { panel.classList.remove('opacity-0'); content.classList.remove('translate-x-full'); }, 10);
            } else {
                panel.classList.add('opacity-0');
                content.classList.add('translate-x-full');
                setTimeout(() => panel.classList.add('hidden'), 300);
            }
        };

        window.applyFilters = () => {
            filterUsers(); 
            toggleFilters();
        };

        window.resetFilters = () => {
            document.getElementById('filter-prefecture').value = "";
            document.getElementById('filter-gender').value = "";
            document.getElementById('filter-job').value = "";
            document.getElementById('filter-can-offer').value = "";
            document.getElementById('filter-looking-for').value = "";
            document.getElementById('filter-sort').value = "random";
            document.getElementById('desktop-search').value = "";
            document.getElementById('mobile-search').value = "";
            document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
            shuffleArray(allUsers);
            filterUsers("");
            toggleFilters();
        };

        function renderGrid(users) {
            const grid = document.getElementById('users-grid');
            const noResults = document.getElementById('no-results');
            if (!grid) return;
            grid.innerHTML = '';

            if (users.length === 0) {
                grid.classList.add('hidden');
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            grid.classList.remove('hidden');

            users.forEach(user => {
                const card = document.createElement('a');
                card.href = `user.html?uid=${user.authUid}`;
                card.className = `block bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-md hover:border-brand-200 transition-all duration-200 flex flex-col h-full group ${user.isHidden ? 'opacity-60 grayscale' : ''}`;
                
                let iconHtml = '';
                if (user.photoURL) {
                    iconHtml = `<img src="${user.photoURL}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy">`;
                } else {
                    iconHtml = `<div class="w-full h-full bg-slate-50 flex items-center justify-center text-slate-300"><i class="fa-solid fa-user text-3xl"></i></div>`;
                }

                // éå…¬é–‹ãƒãƒƒã‚¸ (ç®¡ç†è€…ç”¨)
                const hiddenBadge = user.isHidden ? `<span class="absolute top-1 left-1 bg-gray-800 text-white text-[9px] px-1.5 py-0.5 rounded font-bold">éå…¬é–‹</span>` : '';

                card.innerHTML = `
                    <div class="aspect-square w-full relative overflow-hidden">
                        ${iconHtml}
                        ${hiddenBadge}
                        ${user.prefecture ? `<span class="absolute bottom-1 right-1 bg-black/60 backdrop-blur-sm text-white text-[10px] px-1.5 py-0.5 rounded font-medium">${user.prefecture}</span>` : ''}
                    </div>
                    <div class="p-2 sm:p-3 flex-1 flex flex-col">
                        <h3 class="font-bold text-xs sm:text-sm text-slate-900 leading-tight truncate mb-0.5">${user.name}</h3>
                        <p class="text-[10px] sm:text-xs text-slate-400 truncate mb-1">@${user.userId}</p>
                        ${user.jobTitle ? `<p class="text-[10px] text-brand-600 bg-brand-50 px-1.5 py-0.5 rounded self-start truncate max-w-full">${user.jobTitle}</p>` : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        window.handleLogout = () => {
            if (isAdminMock) localStorage.removeItem('isAdminMock');
            signOut(auth);
            window.location.href = 'login.html';
        };
    </script>
</body>
</html>
