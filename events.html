<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>イベント | BRAIN BRIDGE</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'Noto Sans JP', 'sans-serif'] },
                    colors: { brand: { 500: '#6366f1', 600: '#4f46e5' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; overflow: hidden; /* マップ用 */ }
        .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
        .pb-safe-bottom { padding-bottom: calc(4rem + env(safe-area-inset-bottom)); }
        
        /* Map Container */
        #map { height: 100vh; width: 100%; z-index: 0; }

        /* Detail Sheet Transition */
        #event-sheet { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .sheet-open { transform: translateY(0%) !important; }
        .sheet-closed { transform: translateY(100%); }

        /* Custom Popup Style */
        .leaflet-popup-content-wrapper { border-radius: 0.75rem; overflow: hidden; padding: 0; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        .leaflet-popup-tip { background: white; }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen w-screen relative">

    <!-- Header (Search & Filter) -->
    <div class="absolute top-0 w-full z-[1000] px-4 pt-4 pb-2 bg-gradient-to-b from-white/80 to-transparent pointer-events-none">
        <div class="flex gap-2 pointer-events-auto max-w-2xl mx-auto">
            <div class="relative flex-1 shadow-lg rounded-full">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="map-search" placeholder="イベントを検索..." 
                    class="w-full bg-white border-none rounded-full py-3 pl-11 pr-4 text-sm focus:ring-2 focus:ring-brand-500 shadow-sm">
            </div>
            <button onclick="toggleFilters()" class="w-11 h-11 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-600 hover:text-brand-600 transition-colors relative">
                <i class="fa-solid fa-sliders"></i>
                <span id="filter-badge" class="hidden absolute top-0 right-0 w-3 h-3 bg-brand-500 rounded-full border-2 border-white"></span>
            </button>
        </div>
    </div>

    <!-- Map Area -->
    <div id="map"></div>

    <!-- Create Button (FAB) - Walker非表示 -->
    <button id="create-event-fab" onclick="startCreateEvent()" class="hidden absolute bottom-24 right-5 z-[900] w-14 h-14 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center hover:bg-slate-800 hover:scale-105 transition-all">
        <i class="fa-solid fa-plus text-xl"></i>
    </button>

    <!-- Create Guide Toast -->
    <div id="create-guide" class="hidden absolute top-20 left-1/2 transform -translate-x-1/2 z-[1100] bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl text-sm font-bold animate-bounce cursor-pointer" onclick="cancelCreate()">
        <i class="fa-solid fa-location-dot text-red-400 mr-2"></i>開催場所をタップしてください
        <span class="ml-2 text-xs font-normal text-slate-400">(キャンセル)</span>
    </div>

    <!-- Event Detail Sheet (Slide Up) -->
    <div id="event-sheet" class="sheet-closed absolute bottom-0 left-0 w-full z-[2000] bg-white rounded-t-3xl shadow-2xl pb-safe-bottom max-h-[85vh] overflow-y-auto lg:w-[400px] lg:left-4 lg:bottom-4 lg:rounded-3xl lg:max-h-[80vh] lg:pb-0 lg:transform-none lg:hidden">
        
        <!-- Drag Handle -->
        <div class="sticky top-0 bg-white z-10 pt-3 pb-2 flex justify-center" onclick="closeSheet()">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
        </div>

        <div id="sheet-content" class="px-5 pb-20 lg:pb-5">
            <!-- Loading -->
            <div class="animate-pulse space-y-4">
                <div class="h-40 bg-slate-100 rounded-xl"></div>
                <div class="h-6 bg-slate-100 rounded w-3/4"></div>
                <div class="h-4 bg-slate-100 rounded w-1/2"></div>
            </div>
        </div>
    </div>

    <!-- Create Modal -->
    <div id="create-modal" class="hidden fixed inset-0 z-[3000] bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-[500px] h-[90vh] sm:h-auto sm:max-h-[85vh] rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col">
            
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg">イベントを作成</h3>
                <button onclick="closeCreateModal()" class="p-2 text-slate-400 hover:text-slate-600 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto flex-1 space-y-5">
                <!-- Image Upload -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2">サムネイル画像</label>
                    <div class="relative w-full h-32 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400 hover:bg-slate-100 cursor-pointer overflow-hidden">
                        <input type="file" id="event-image" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                        <img id="image-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                        <i class="fa-solid fa-image text-2xl mb-1"></i>
                        <span class="text-xs">タップして画像を選択</span>
                    </div>
                </div>

                <!-- Title -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">イベント名 <span class="text-red-500">*</span></label>
                    <input type="text" id="event-title" class="w-full border-slate-200 rounded-lg text-sm p-2.5 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-brand-500" required>
                </div>

                <!-- Date & Time -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">日付 <span class="text-red-500">*</span></label>
                        <input type="date" id="event-date" class="w-full border-slate-200 rounded-lg text-sm p-2.5 bg-slate-50" required>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-500 mb-1">開始</label>
                            <input type="time" id="event-start" class="w-full border-slate-200 rounded-lg text-sm p-2.5 bg-slate-50">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-500 mb-1">終了</label>
                            <input type="time" id="event-end" class="w-full border-slate-200 rounded-lg text-sm p-2.5 bg-slate-50">
                        </div>
                    </div>
                </div>

                <!-- Location -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">開催場所（座標は自動設定済）</label>
                    <input type="text" id="event-location-name" placeholder="場所の名前・住所" class="w-full border-slate-200 rounded-lg text-sm p-2.5 bg-slate-50">
                    <p class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-map-pin mr-1"></i>地図でタップした位置にピンが立ちます</p>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">詳細・内容</label>
                    <textarea id="event-desc" rows="4" class="w-full border-slate-200 rounded-lg text-sm p-2.5 bg-slate-50" placeholder="イベントの魅力を伝えましょう"></textarea>
                </div>

                <!-- Tags -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">タグ (カンマ区切り)</label>
                    <input type="text" id="event-tags" placeholder="交流会, ランチ, 初心者歓迎" class="w-full border-slate-200 rounded-lg text-sm p-2.5 bg-slate-50">
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-white pb-safe-bottom sm:pb-4">
                <button onclick="submitEvent()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 transition-colors shadow-lg">
                    イベントを作成する
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Panel (Same as search.html) -->
    <div id="filter-panel" class="fixed top-0 left-0 w-full h-full bg-black/50 z-[3000] hidden opacity-0 transition-opacity duration-300">
        <div class="absolute right-0 top-0 h-full w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col" id="filter-content">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg">フィルター</h3>
                <button onclick="toggleFilters()" class="p-2 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 flex-1 space-y-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">タグ</label>
                    <input type="text" id="filter-tag" placeholder="例: 交流会" class="w-full border-slate-200 rounded-lg text-sm p-2.5">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">期間</label>
                    <select id="filter-date" class="w-full border-slate-200 rounded-lg text-sm p-2.5 bg-slate-50">
                        <option value="all">すべて（開催中・予定）</option>
                        <option value="today">今日</option>
                        <option value="week">1週間以内</option>
                        <option value="month">1ヶ月以内</option>
                    </select>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 pb-safe-bottom">
                <button onclick="applyFilters()" class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl hover:bg-brand-700 shadow-md">適用する</button>
                <button onclick="resetFilters()" class="w-full mt-3 text-sm text-slate-500">リセット</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-slate-200 z-[1900] safe-area-pb">
        <div class="flex justify-around items-center h-16">
            <a href="index.html" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                <span class="text-[10px] font-medium">ホーム</span>
            </a>
            <!-- Events Active -->
            <a href="events.html" class="flex flex-col items-center justify-center w-full h-full text-brand-600">
                <i class="fa-solid fa-map-location-dot text-xl mb-1"></i>
                <span class="text-[10px] font-bold">イベント</span>
            </a>
            <a href="search.html" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-magnifying-glass text-xl mb-1"></i>
                <span class="text-[10px] font-medium">さがす</span>
            </a>
            <button onclick="alert('マッチング機能は準備中です。\nComing Soon!')" class="flex flex-col items-center justify-center w-full h-full text-slate-300 hover:text-slate-400 transition-colors">
                <i class="fa-solid fa-handshake-simple text-xl mb-1"></i>
                <span class="text-[10px] font-medium">マッチ</span>
            </button>
            <a href="user.html" class="flex flex-col items-center justify-center w-full h-full text-slate-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-user text-xl mb-1"></i>
                <span class="text-[10px] font-medium">マイページ</span>
            </a>
        </div>
    </nav>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = 'default-app-id';

        let map;
        let markers = [];
        let allEvents = [];
        let currentUser = null;
        let isCreating = false;
        let tempMarker = null; // 作成時の仮マーカー
        let selectedCoords = null;
        let myProfile = null; // 自分のプロフィール（作成者名用）

        const isAdminMock = localStorage.getItem('isAdminMock') === 'true';

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
        });

        // --- Auth & Permission ---
        onAuthStateChanged(auth, async (user) => {
            if (isAdminMock) {
                currentUser = { uid: 'test_admin_uid' };
                document.getElementById('create-event-fab').classList.remove('hidden');
                myProfile = { name: '管理者' };
                loadEvents();
                return;
            }

            if (user) {
                currentUser = user;
                
                // ランクチェック (WALKERなら作成ボタン非表示)
                try {
                    const docSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'));
                    if (docSnap.exists()) {
                        myProfile = docSnap.data();
                        const rank = myProfile.membershipRank || 'walker';
                        if (rank !== 'walker') {
                            document.getElementById('create-event-fab').classList.remove('hidden');
                        }
                    }
                } catch (e) { console.error(e); }

                loadEvents();
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- Map Logic ---
        function initMap() {
            // 中心を東京に設定 (現在地取得ができればベストだが今回は固定)
            map = L.map('map', { zoomControl: false }).setView([35.6895, 139.6917], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // マップクリックイベント (作成モード時)
            map.on('click', (e) => {
                if (isCreating) {
                    if (tempMarker) map.removeLayer(tempMarker);
                    tempMarker = L.marker(e.latlng).addTo(map);
                    selectedCoords = e.latlng;
                    openCreateModal();
                }
            });
        }

        // --- Event Loading ---
        async function loadEvents() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const eventsRef = collection(db, 'artifacts', appId, 'public', 'data', 'events');
                // 開催日が今日以降のイベントを取得
                const q = query(eventsRef, where('date', '>=', today), orderBy('date', 'asc'));
                
                const snapshot = await getDocs(q);
                allEvents = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    allEvents.push(data);
                });
                
                renderMarkers(allEvents);

            } catch (e) {
                console.error("Event load error:", e);
            }
        }

        function renderMarkers(events) {
            // Clear existing
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            events.forEach(evt => {
                if (evt.lat && evt.lng) {
                    const marker = L.marker([evt.lat, evt.lng]).addTo(map);
                    
                    // クリックでシート表示
                    marker.on('click', () => {
                        showEventSheet(evt);
                        // PCの場合はマップを少し移動して見やすくする? (今回はスマホ想定でそのまま)
                    });
                    markers.push(marker);
                }
            });
        }

        // --- Sheet & Modal Logic ---
        window.showEventSheet = (evt) => {
            const sheet = document.getElementById('event-sheet');
            const content = document.getElementById('sheet-content');
            
            // Format Data
            const thumb = evt.thumbnailUrl || 'https://via.placeholder.com/400x200?text=No+Image';
            const tags = evt.tags ? evt.tags.map(t => `<span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">#${t}</span>`).join('') : '';

            content.innerHTML = `
                <div class="relative h-48 w-full rounded-2xl overflow-hidden mb-4 shadow-sm">
                    <img src="${thumb}" class="w-full h-full object-cover">
                    <div class="absolute top-2 right-2 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-slate-800 shadow-sm">
                        ${evt.date}
                    </div>
                </div>
                
                <h2 class="text-xl font-bold text-slate-900 leading-tight mb-2">${evt.title}</h2>
                
                <div class="flex flex-wrap gap-2 mb-4">
                    ${tags}
                </div>

                <div class="space-y-3 text-sm text-slate-600 bg-slate-50 p-4 rounded-xl mb-4">
                    <div class="flex items-center gap-3">
                        <i class="fa-regular fa-clock w-5 text-center text-slate-400"></i>
                        <span>${evt.startTime || '--:--'} 〜 ${evt.endTime || '--:--'}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-location-dot w-5 text-center text-slate-400"></i>
                        <span>${evt.locationName || '場所未定'}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-user w-5 text-center text-slate-400"></i>
                        <a href="user.html?uid=${evt.organizerId}" class="text-brand-600 font-bold hover:underline">主催: ${evt.organizerName}</a>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="font-bold text-slate-900 mb-2">詳細</h3>
                    <p class="text-slate-600 leading-relaxed whitespace-pre-wrap">${evt.description || ''}</p>
                </div>
                
                <!-- Future: Join Button -->
                <button onclick="alert('参加機能は準備中です')" class="w-full bg-brand-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-brand-500/30 hover:bg-brand-700 transition-all">
                    イベントに参加する
                </button>
            `;

            sheet.classList.remove('sheet-closed');
            sheet.classList.add('sheet-open');
            // PC表示用（クラス制御）
            sheet.classList.remove('hidden');
        };

        window.closeSheet = () => {
            const sheet = document.getElementById('event-sheet');
            sheet.classList.remove('sheet-open');
            sheet.classList.add('sheet-closed');
            setTimeout(() => sheet.classList.add('hidden'), 300); // PC用Wait
        };

        // --- Create Event Logic ---
        window.startCreateEvent = () => {
            isCreating = true;
            document.getElementById('create-guide').classList.remove('hidden');
            document.getElementById('create-event-fab').classList.add('hidden');
            alert('地図をタップして、イベントの開催場所を指定してください');
        };

        window.cancelCreate = () => {
            isCreating = false;
            if (tempMarker) map.removeLayer(tempMarker);
            document.getElementById('create-guide').classList.add('hidden');
            document.getElementById('create-event-fab').classList.remove('hidden');
        };

        window.openCreateModal = () => {
            document.getElementById('create-modal').classList.remove('hidden');
            // 日付初期値
            document.getElementById('event-date').value = new Date().toISOString().split('T')[0];
        };

        window.closeCreateModal = () => {
            document.getElementById('create-modal').classList.add('hidden');
        };

        // Image Preview
        document.getElementById('event-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('image-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        window.submitEvent = async () => {
            if (!currentUser) return;
            
            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            if (!title || !date) return alert('タイトルと日付は必須です');

            // Upload Image
            let thumbnailUrl = '';
            const file = document.getElementById('event-image').files[0];
            if (file) {
                try {
                    const path = `events/${currentUser.uid}/${Date.now()}_${file.name}`;
                    const snap = await uploadBytes(ref(storage, path), file);
                    thumbnailUrl = await getDownloadURL(snap.ref);
                } catch (e) {
                    console.error("Upload err", e);
                    return alert("画像のアップロードに失敗しました");
                }
            }

            const eventData = {
                title: title,
                date: date,
                startTime: document.getElementById('event-start').value,
                endTime: document.getElementById('event-end').value,
                locationName: document.getElementById('event-location-name').value,
                description: document.getElementById('event-desc').value,
                tags: document.getElementById('event-tags').value.split(',').map(s => s.trim()).filter(s => s),
                thumbnailUrl: thumbnailUrl,
                lat: selectedCoords.lat,
                lng: selectedCoords.lng,
                organizerId: currentUser.uid,
                organizerName: myProfile ? (myProfile.name || myProfile.userId) : '主催者',
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'events'), eventData);
                
                alert('イベントを作成しました！');
                closeCreateModal();
                cancelCreate(); // Reset mode
                loadEvents(); // Reload
            } catch (e) {
                console.error("Create err", e);
                alert('イベント作成に失敗しました');
            }
        };

        // --- Filter Logic ---
        window.toggleFilters = () => {
            const panel = document.getElementById('filter-panel');
            const content = document.getElementById('filter-content');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                setTimeout(() => { panel.classList.remove('opacity-0'); content.classList.remove('translate-x-full'); }, 10);
            } else {
                panel.classList.add('opacity-0');
                content.classList.add('translate-x-full');
                setTimeout(() => panel.classList.add('hidden'), 300);
            }
        };

        window.applyFilters = () => {
            const keyword = document.getElementById('map-search').value.toLowerCase();
            const tag = document.getElementById('filter-tag').value.toLowerCase();
            // Simple Client-side filter
            const filtered = allEvents.filter(evt => {
                const matchKey = !keyword || evt.title.toLowerCase().includes(keyword) || evt.description.toLowerCase().includes(keyword);
                const matchTag = !tag || (evt.tags && evt.tags.some(t => t.toLowerCase().includes(tag)));
                return matchKey && matchTag;
            });
            renderMarkers(filtered);
            toggleFilters();
        };

        window.resetFilters = () => {
            document.getElementById('map-search').value = "";
            document.getElementById('filter-tag').value = "";
            renderMarkers(allEvents);
            toggleFilters();
        };

        // Search Input Listener
        document.getElementById('map-search').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            const filtered = allEvents.filter(evt => evt.title.toLowerCase().includes(val));
            renderMarkers(filtered);
        });

    </script>
</body>
</html>
